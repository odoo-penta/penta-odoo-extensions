<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- Layout propio: SOLO header/page/footer. Sin html_container -->
  <template id="external_layout_ximport">
    <t t-set="company" t-value="(doc.company_id or env.company)"/>

    <!-- Header con logo + datos empresa -->
    <div class="header">
      <div style="display:flex; gap:16px; align-items:flex-start;">
        <div style="flex:0 0 auto;">
          <img t-att-src="'/web/image/res.company/%s/logo' % company.id" style="max-height:80px;"/>
        </div>
        <div style="flex:1 1 auto; line-height:1.4;">
          <strong><t t-esc="company.name"/></strong><br/>
          <t t-if="company.street"><t t-esc="company.street"/><br/></t>
          <t t-if="company.street2"><t t-esc="company.street2"/><br/></t>
          <t t-if="company.city"><t t-esc="company.city"/></t>
          <t t-if="company.state_id">, <t t-esc="company.state_id.name"/></t>
          <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t>
        </div>
      </div>
    </div>

    <!-- Contenido por página: aquí se inyecta el cuerpo del reporte -->
    <div class="page">
      <t t-raw="0"/>
    </div>

    <!-- Pie opcional -->
    <div class="footer"/>
  </template>

  <!-- Documento: ahora envuelto en web.basic_layout (agrega <meta charset="utf-8">) -->
  <template id="report_x_import_header_document">
    <t t-call="web.basic_layout">
      <t t-foreach="docs" t-as="doc">
        <t t-call="import_module.external_layout_ximport">

            <!-- ===== Contenido específico de x.import ===== -->
            <h3 style="margin-top:15px; margin-bottom:8px;">Ficha de Importación</h3>

            <!-- 2 columnas robustas para PDF -->
            <div style="width:100%; overflow:hidden; margin-top:8px;">

            <!-- Columna izquierda -->
            <div style="float:left; width:48%; padding-right:2%;">

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Referencia</span>
                <span style="display:block; font-size:12px; line-height:1.4;"><t t-esc="doc.reference or ''"/></span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Guía de importación</span>
                <span style="display:block; font-size:12px; line-height:1.4;"><t t-esc="doc.guide_bl or ''"/></span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Fecha guía de importación</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.date"><span t-field="doc.date" /></t>
                    <t t-if="not doc.date">—</t>
                </span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">DAI</span>
                <span style="display:block; font-size:12px; line-height:1.4;"><t t-esc="doc.dai or ''"/></span>
                </div>

            </div>

            <!-- Columna derecha -->
            <div style="float:right; width:48%; padding-left:2%;">

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">País de origen</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.country"><span t-field="doc.country"/></t>
                    <t t-if="not doc.country">—</t>
                </span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Puerto de embarque</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.port_of_loading_id"><span t-field="doc.port_of_loading_id"/></t>
                    <t t-if="not doc.port_of_loading_id">—</t>
                </span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Puerto de llegada</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.port_of_discharge_id"><span t-field="doc.port_of_discharge_id"/></t>
                    <t t-if="not doc.port_of_discharge_id">—</t>
                </span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Número de póliza de seguro</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.insurance_policy_number">
                    <t t-esc="doc.insurance_policy_number"/>
                    </t>
                    <t t-if="not doc.insurance_policy_number">—</t>
                </span>
                </div>

                <div style="margin-bottom:10px;">
                <span style="display:block; font-weight:700; font-size:14px; line-height:1.2;">Fecha de liquidación</span>
                <span style="display:block; font-size:12px; line-height:1.4;">
                    <t t-if="doc.date_liquidation"><span t-field="doc.date_liquidation"/></t>
                    <t t-if="not doc.date_liquidation">—</t>
                </span>
                </div>

            </div>
            </div>
            <div style="clear:both;"></div>
           
<!-- 1) Productos usados en las líneas de costos en destino -->
<t t-set="lc_product_ids" t-value="doc.stock_landed_cost_ids.mapped('cost_lines.product_id').ids"/>

<!-- 2) Líneas de factura que usan esos productos (solo facturas proveedor válidas) -->
<t t-set="inv_lines" t-value="env['account.move.line'].search([
  ('product_id', 'in', lc_product_ids),
  ('move_id.move_type', '=', 'in_invoice'),
  ('move_id.state', '!=', 'cancel'),
])"/>

<!-- 3) Conjunto de facturas derivadas de esas líneas -->
<t t-set="invoices" t-value="inv_lines.mapped('move_id')"/>
<t t-set="invoice_ids" t-value="invoices.ids"/>

<!-- 4) CIF: facturas con líneas de productos L/C tipo freight o insurance -->
<t t-set="cif_invoices" t-value="env['account.move'].search([
  ('id', 'in', invoice_ids),
  ('move_type', '=', 'in_invoice'),
  ('state', '!=', 'cancel'),
  ('invoice_line_ids.product_id.product_tmpl_id.landed_cost_ok', '=', True),
  ('invoice_line_ids.product_id.landed_cost_type', 'in', ('freight', 'insurance')),
])"/>

<!-- 5) FOB: facturas con líneas L/C que NO sean freight/insurance (p. ej., customs/otros) -->
<t t-set="fob_invoices" t-value="env['account.move'].search([
  ('id', 'in', invoice_ids),
  ('move_type', '=', 'in_invoice'),
  ('state', '!=', 'cancel'),
  ('invoice_line_ids.product_id.product_tmpl_id.landed_cost_ok', '=', True),
  ('invoice_line_ids.product_id.landed_cost_type', 'not in', ('freight', 'insurance')),
])"/>

<!-- 6) (Opcional) Factura de mercadería del exterior SIN landed_cost_ok,
        tomada de las OCs del x.import (sin usar id_import) -->
<t t-set="po_names" t-value="doc.purchase_ids.mapped('name')"/>
<t t-set="merch_invoice" t-value="env['account.move'].search([
  ('invoice_origin', 'in', po_names),
  ('move_type', '=', 'in_invoice'),
  ('state', '!=', 'cancel'),
  ('invoice_line_ids.product_id.product_tmpl_id.landed_cost_ok', '=', False),
], limit=1)"/>

<!-- map cortesía para mostrar tipo legible -->
<t t-set="tipo_map" t-value="{'freight':'Flete','insurance':'Seguro','customs':'Aduana'}"/>

<!-- ============= helpers para computar 'Tipo' por factura sin lambda ni sets ============= -->
<!-- Por factura CIF: contamos si hay freight y/o insurance -->
<t t-set="cnt_freight_dummy" t-value="0"/> <!-- no usado, sólo recordatorio -->
<!-- ============================ SECCIÓN: COSTOS CIF ============================ -->
<h4 style="margin:18px 0 10px 0;">Costos CIF</h4>

<t t-if="cif_invoices or merch_invoice">
  <table style="width:100%; border-collapse:collapse;">
    <!-- MISMAS PROPORCIONES EN AMBAS TABLAS -->
    <colgroup>
      <col style="width:12%"/>  <!-- Fecha -->
      <col style="width:22%"/>  <!-- Proveedor -->
      <col style="width:24%"/>  <!-- Factura de proveedor -->
      <col style="width:14%"/>  <!-- Referencia -->
      <col style="width:16%"/>  <!-- Total -->
      <col style="width:12%"/>  <!-- Tipo -->
    </colgroup>
    <thead>
      <tr>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Fecha</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Proveedor</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Factura de proveedor</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Referencia</th>
        <th style="text-align:right; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Total (sin impuestos)</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Tipo</th>
      </tr>
    </thead>
    <tbody>
      <!-- filas CIF por factura -->
      <t t-foreach="cif_invoices" t-as="inv">
        <!-- contar tipos presentes en ESTA factura -->
        <t t-set="cnt_f" t-value="env['account.move.line'].search_count([
          ('move_id','=', inv.id),
          ('product_id.product_tmpl_id.landed_cost_ok','=', True),
          ('product_id.landed_cost_type','=','freight')
        ])"/>
        <t t-set="cnt_i" t-value="env['account.move.line'].search_count([
          ('move_id','=', inv.id),
          ('product_id.product_tmpl_id.landed_cost_ok','=', True),
          ('product_id.landed_cost_type','=','insurance')
        ])"/>

        <tr>
          <td style="padding:6px 4px; font-size:11.5px;"><span t-field="inv.invoice_date"/></td>
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.invoice_partner_display_name or ''"/></td> <!-- Proveedor -->
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.name or ''"/></td> <!-- Factura -->
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.ref or ''"/></td>  <!-- Referencia -->
          <td style="padding:6px 4px; font-size:11.5px; text-align:right;"><span t-field="inv.amount_untaxed_in_currency_signed"/></td>
          <td style="padding:6px 4px; font-size:11.5px;">
            <t t-if="cnt_f and cnt_i">Flete, Seguro</t>
            <t t-if="cnt_f and not cnt_i">Flete</t>
            <t t-if="cnt_i and not cnt_f">Seguro</t>
          </td>
        </tr>
      </t>

      <!-- fila para Factura de mercadería del exterior (si existe) -->
      <t t-if="merch_invoice">
        <t t-set="inv" t-value="merch_invoice"/>
        <tr>
          <td style="padding:6px 4px; font-size:11.5px;"><span t-field="inv.invoice_date"/></td>
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.invoice_partner_display_name or ''"/></td>
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.name or ''"/></td>
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.ref or ''"/></td>
          <td style="padding:6px 4px; font-size:11.5px; text-align:right;"><span t-field="inv.amount_untaxed_in_currency_signed"/></td>
          <td style="padding:6px 4px; font-size:11.5px;">Mercadería</td>
        </tr>
      </t>
    </tbody>
  </table>
</t>
<t t-if="not cif_invoices and not merch_invoice">
  <p style="color:#666; font-size:11.5px;">No hay costos CIF.</p>
</t>

<!-- ============================ SECCIÓN: COSTOS FOB ============================ -->
<h4 style="margin:18px 0 10px 0;">Costos FOB</h4>

<t t-if="fob_invoices">
  <table style="width:100%; border-collapse:collapse;">
    <!-- MISMAS PROPORCIONES EN AMBAS TABLAS -->
    <colgroup>
      <col style="width:12%"/>  <!-- Fecha -->
      <col style="width:22%"/>  <!-- Proveedor -->
      <col style="width:24%"/>  <!-- Factura de proveedor -->
      <col style="width:14%"/>  <!-- Referencia -->
      <col style="width:16%"/>  <!-- Total -->
      <col style="width:12%"/>  <!-- Tipo -->
    </colgroup>
    <thead>
      <tr>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Fecha</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Proveedor</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Factura de proveedor</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Referencia</th>
        <th style="text-align:right; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Total (sin impuestos)</th>
        <th style="text-align:left; font-weight:700; font-size:12.5px; border-bottom:1px solid #ddd; padding:6px 4px;">Tipo</th>
      </tr>
    </thead>
    <tbody>
      <t t-foreach="fob_invoices" t-as="inv">
        <!-- contar customs en ESTA factura -->
        <t t-set="cnt_c" t-value="env['account.move.line'].search_count([
          ('move_id','=', inv.id),
          ('product_id.product_tmpl_id.landed_cost_ok','=', True),
          ('product_id.landed_cost_type','=','customs')
        ])"/>

        <tr>
          <td style="padding:6px 4px; font-size:11.5px;"><span t-field="inv.invoice_date"/></td>
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.invoice_partner_display_name or ''"/></td> <!-- Proveedor -->
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.name or ''"/></td> <!-- Factura -->
          <td style="padding:6px 4px; font-size:11.5px;"><t t-esc="inv.ref or ''"/></td>  <!-- Referencia -->
          <td style="padding:6px 4px; font-size:11.5px; text-align:right;"><span t-field="inv.amount_untaxed_in_currency_signed"/></td>
          <td style="padding:6px 4px; font-size:11.5px;">
            <t t-if="cnt_c">Aduana</t>
            <t t-if="not cnt_c">Otro costo</t>
          </td>
        </tr>
      </t>
    </tbody>
  </table>
</t>
<t t-if="not fob_invoices">
  <p style="color:#666; font-size:11.5px;">No hay costos FOB.</p>
</t>


        </t>
      </t>
    </t>
  </template>

</odoo>
