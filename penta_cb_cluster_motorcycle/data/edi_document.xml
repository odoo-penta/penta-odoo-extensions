<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Herencia para insertar los detalles adicionales despuÃ©s del precioTotalSinImpuesto -->
        <template id="common_details_info_template_extend" inherit_id="l10n_ec_edi.common_details_info_template">
            <xpath expr="//detalles" position="replace">
                <t t-set="lotes_linea_usados" t-value="[]"/>

                <detalles t-if="lines">
                    <t t-foreach="lines.items()" t-as="line_items">
                        <t t-set="line" t-value="line_items[0]"/>
                        <t t-set="line_tax_details" t-value="line_items[1]['tax_details']"/>
                        <t t-set="product" t-value="line.product_id"/>
                        <t t-set="product_code" t-value="product and (product.barcode or product.default_code or 'N/A')[:25]"/>
                        <t t-set="line_edi_values" t-value="line._l10n_ec_prepare_edi_vals_to_export_USD()"/>

                        <!-- LOOP por cantidad -->
                        <detalle t-foreach="range(int(line.quantity))" t-as="unit_index">

                            <codigoInterno t-if="is_cnote" t-out="product_code"/>
                            <codigoAdicional t-if="is_cnote" t-out="product.l10n_ec_auxiliary_code"/>
                            <codigoPrincipal t-if="is_invoice or is_liquidation" t-out="product_code"/>
                            <codigoAuxiliar t-if="is_invoice or is_liquidation" t-out="product.l10n_ec_auxiliary_code"/>

                            <descripcion t-out="clean_str(line.name or line.product_id and line.product_id.name or 'OTRO')"/>

                            <!-- Cantidad siempre 1 por cada unidad -->
                            <cantidad>1.000000</cantidad>

                            <!-- precio unitario no cambia -->
                            <precioUnitario t-out="format_num_6(line_edi_values['price_unit'])"/>

                            <!-- Descuento por unidad (dividir por quantity si corresponde) -->
                            <descuento t-out="format_num_2((line_edi_values['price_discount'] + abs(line.balance) - line_items[1]['base_amount']) / line.quantity)"/>

                            <!-- Total sin impuesto por unidad -->
                            <precioTotalSinImpuesto t-out="format_num_2(abs(line_items[1]['base_amount']) / line.quantity)"/>

                            <t t-set="atributos_combinados" t-value="[]"/>
                            <t t-foreach="line.product_id.product_template_attribute_value_ids" t-as="attr">
                                <t t-set="atributos_combinados" t-value="atributos_combinados + ['%s: %s' % (attr.attribute_id.name, attr.name)]"/>
                            </t>

                            <!-- Ahora tomamos los datos del lote -->
                            <t t-set="ramv_val" t-value="' '"/>
                            <t t-set="motor_val" t-value="' '"/>
                            <t t-set="lote_val" t-value="' '"/>
                            
                            <!-- Buscamos el lote (si existe en move_line) -->
                             <t t-if="line.move_id.stock_lot_ids">
                                <t t-foreach="line.move_id.stock_lot_ids" t-as="lot">
                                    <t t-if="lot.product_id.id == line.product_id.id and (lot.name not in lotes_linea_usados) and lote_val == ' '">

                                        <!-- asignar valores -->
                                        <t t-set="ramv_val" t-value="lot.ramv or ' '"/>
                                        <t t-set="motor_val" t-value="lot.motor_number or ' '"/>
                                        <t t-set="lote_val" t-value="lot.name or ' '"/>

                                        <!-- marca el lote como usado -->
                                        <t t-set="lotes_linea_usados" t-value="lotes_linea_usados + [lot.name]"/>
                                    </t>
                                </t>
                            </t>
                            
                            <!-- Bloque a insertar -->
                            <t t-if="atributos_combinados or ramv_val.strip() or motor_val.strip() or lote_val.strip()">
                                <detallesAdicionales>
                                    <detAdicional
                                        t-att="{
                                            'nombre': 'Atributos',
                                            'valor': (
                                                '|'.join(atributos_combinados)
                                                + '| Ramv: ' + ramv_val
                                                + '| Placa: ' + motor_val
                                                + '| Chasis: ' + lote_val
                                            ) if atributos_combinados or ramv_val.strip() or motor_val.strip() or lote_val.strip() else ' '
                                        }"
                                        t-out=" "
                                    />
                                </detallesAdicionales>
                            </t>
                            <impuestos t-if="line_tax_details">
                                <impuesto t-foreach="line_tax_details.values()" t-as="tax_data">
                                    <t t-call="penta_cb_cluster_motorcycle.common_tax_lines_template_2">
                                        <t t-set="tarifa_pre_base" t-value="True"/>
                                        <t t-set="line_quantity" t-value="line.quantity"/>
                                    </t>
                                </impuesto>
                            </impuestos>
                        </detalle>
                    </t>
                </detalles>
            </xpath>
        </template>
        <template id="common_tax_lines_template_2">
            <codigo t-out="tax_data['code']"/>
            <codigoPorcentaje t-out="tax_data['code_percentage']"/>
            <tarifa t-if="tarifa_pre_base" t-out="format_num_6(abs(tax_data['rate']))"/>
            <baseImponible t-out="format_num_6(currency_round(abs(tax_data['base_amount']) / line_quantity))"/>
            <tarifa t-if="tarifa_post_base" t-out="format_num_6(abs(tax_data['rate']))"/>
            <valor t-out="format_num_2(abs(tax_data['tax_amount']) / line_quantity)"/>
        </template>
    </data>
</odoo>